(function() {
    const app = angular.module('filesync.chat', [
        //'filesync.chat.bot',
        'filesync.chat.input',
        'filesync.chat.messages',
        'filesync.chat.viewers',
        'filesync.chat.socket'
    ]);
})();

(function() {
    const app = angular.module('filesync.history', []);
})();

(function() {
    const app = angular.module('filesync.chat.input', [
    ]);
})();

(function() {
    const app = angular.module('filesync.chat.messages', [
    ]);
})();

(function() {
    const app = angular.module('filesync.chat.socket', [
    ]);
})();

(function() {
    const app = angular.module('filesync.chat.viewers', [
    ]);
})();

(function () {
	const app = angular.module('filesync', [
		'ui.router',
		'ngAnimate',
		'hljs',

		'filesync.chat',
		'filesync.history'
	]);

	app.constant('io', io)
		.constant('Visibility', Visibility)
		.constant('_', _);

	app.config(function ($stateProvider, $locationProvider, $urlRouterProvider) {

		$locationProvider.html5Mode(true);

		$stateProvider.state('index', {
			url: '/',
			templateUrl: '/index.html'
		});

		$urlRouterProvider.otherwise('/');
	});

})();

(function () {

	angular.module('filesync')
		.factory('visibilityService', ['Visibility', 'socketService',
            function (Visibility, socketService) {
				Visibility.change(function (evt, state) {
					// state === 'hidden' || 'visible'
					socketService.userChangedState(state);
				});

				socketService.userChangedState('visible');

				var service = {
					states: {}
				};

				socketService.onVisibilityStatesChanged(function (states) {
					service.states = states;
				});
				return service;
            }
        ]);
})();

(function () {

	const app = angular.module('filesync.chat')
		.controller('chatController', ['$scope', function ($scope) {
            // Maybe use angular-scroll for new messages scroll down and goto messages, pinned etc
			let vm = this;



		}])
})();

(function () {
	const app = angular.module('filesync.chat');

	app.directive('fsChat', function () {
		return {
			restrict: 'AE',
			templateUrl: '/app/chat/chat.part.html'
		}
	});
})();

(function () {

	const app = angular.module('filesync.history');

	app.controller('historyController', ['historyService', 'visibilityService',
        function (historyService, visibilityService) {
			this.edits = historyService.edits;
			this.visibility = visibilityService;

			this.remove = function (edit) {
				historyService.remove(edit);
			};
  }
]);
})();

(function () {

	const app = angular.module('filesync.history');

	app.factory('historyService', function (socketService, _) {
		var edits = [];

		socketService.onFileChanged(function (filename, timestamp, content) {
			edits.unshift({
				filename: filename,
				timestamp: timestamp,
				content: content
			});
		});

		return {
			edits: edits,
			remove: function (edit) {
				_.remove(edits, edit);
			}
		};
	});
})();

(function () {

	const app = angular.module('filesync.chat.input')
		.controller('inputController', ['$scope', 'socketService', function ($scope, socketService) {
            // Maybe use angular-scroll for new messages scroll down and goto messages, pinned etc
			let vm = this;
			var bannedWord = ["", "*", " "];

			function addBannedWord(word) {
				vm.bannedWord.push(word);
			}

			function isMsgOk(msg) {
				return bannedWord.filter((word) => word === msg)
					.length === 0;
			}

			function isMsgToBot(msg) {
				return msg.search('!bot') == 0;
			}

			function newMsgToBot(msg) {
				var command = msg.split(' ');
				console.log(command);
				switch(command[1]) {
				case 'roulette':
					socketService.botRoulette();
					break;
				case 'infoCours':
					socketService.botInfoCours();
					break;
				case 'updateInfo':
					command.shift();
					command.shift();
					socketService.botUpdateInfo(command.join(' '));
					break;
				case 'command':
					socketService.botCommand();
					break;
				}
			}

			vm.sendMessage = function () {
				var msg = vm.message;
				if(isMsgToBot(msg)) {
					newMsgToBot(msg);
				} else if(isMsgOk(msg)) {
					socketService.sendMessage(moment()
						.format('h:mm'), msg);
					vm.message = '';
				} else {
					console.log('Mot interdit !' + bannedWord);
				}
			}
		}])
})();

(function () {
	const app = angular.module('filesync.chat.input');

	app.directive('fsInput', function () {
		return {
			restrict: 'AE',
			templateUrl: '/app/chat/input/input.part.html',
			// link: function() {
			//
			// }
		}
	});
})();

(function () {
	const app = angular.module('filesync.chat.messages')
		.controller('messagesController', ['$scope', 'socketService', function ($scope, socketService) {
            // Maybe use angular-scroll for new messages scroll down and goto messages, pinned etc
			let vm = this;
			vm.messages = [];
			vm.message = '';
			function onMessagesUpdated(messages) {
				vm.messages = messages;
				$scope.$apply();
			}
			socketService.onMessagesUpdated(onMessagesUpdated.bind(vm));

		}])
})();

(function () {
	const app = angular.module('filesync.chat.messages');

	app.directive('fsMessages', function () {
		return {
			restrict: 'AE',
			templateUrl: '/app/chat/messages/messages.part.html',
			controller: "messagesController",
			controllerAs: "mC",
			link: function ($scope, element) {
				let raw = element[0].children[0];
				$scope.$watch('mC.messages', function (newValue, oldValue) {
					raw.scrollTop = raw.scrollHeight;
				})
			}
		}
	});
})();

(function () {


	const app = angular.module('filesync.chat.socket')
		.factory('socketService', ['io', '_', '$timeout', function (io, _, $timeout) {
			var socket = io();
			var _onFileChanged = _.noop;
			var _onVisibilityStatesChanged = _.noop;

			socket.on('connect', function () {
				console.log('connected');
				var login = prompt('Nickname?');
				if(login == null) {
					login = "";
				}
				socket.emit('viewer:new', login);
			});

			socket.on('file:changed', function (filename, timestamp, content) {
				$timeout(function () {
					_onFileChanged(filename, timestamp, content);
				});
			});

			socket.on('viewer-err:name', function (nickname) {
				console.log("Erreur sur le nom " + nickname + ".");
				var login = prompt("Erreur sur le nom " + nickname + ".\nNew nickname?");
				if(login == null) {
					login = "";
				}
				socket.emit('viewer:new', login);
			});

			socket.on('users:visibility-states', function (states) {
				$timeout(function () {
					_onVisibilityStatesChanged(states);
				});
			});

			socket.on('error:auth', function (err) {
				// @todo yeurk
				alert(err);
			});

			return {
				onViewersUpdated: function (f) {
					socket.on('viewers:updated', f);
				},

				sendMessage: function (time, message) {
					socket.emit('message:new', time, message);
				},

				updateColor: function (color) {
					socket.emit('color:update', color)
				},

				onMessagesUpdated: function (f) {
					socket.on('messages:updated', f);
				},

				botRoulette: function () {
					socket.emit('bot:roulette');
				},

				botInfoCours: function () {
					socket.emit('bot:info');
				},

				botUpdateInfo: function (newInfo) {
					socket.emit('bot:updateInfo', newInfo);
				},

				botCommand: function () {
					socket.emit('bot:command');
				},

				onFileChanged: function (f) {
					_onFileChanged = f;
				},

				onVisibilityStatesChanged: function (f) {
					_onVisibilityStatesChanged = f;
				},

				userChangedState: function (state) {
					socket.emit('user-visibility:changed', state);
				}
			};
  }]);
})();

(function () {

	const app = angular.module('filesync.chat')
		.controller('viewersController', ['$scope', 'socketService', function ($scope, socketService) {
            // Maybe use angular-scroll for new messages scroll down and goto messages, pinned etc
			let vm = this;
			vm.viewers = [];

			$scope.nick = "Malo";

			function onViewersUpdated(viewers) {
				vm.viewers = viewers;
				$scope.$apply();
			}
			socketService.onViewersUpdated(onViewersUpdated.bind(vm));

			function showColor(color) {
				console.log(color);
			}

			vm.updateColor = function () {
				socketService.updateColor(vm.color);
			}
		}])
})();

(function () {
	const app = angular.module('filesync.chat.viewers');

	app.directive('fsViewers', function () {
		return {
			restrict: 'AE',
			templateUrl: '/app/chat/viewers/viewers.part.html',
			controller: "viewersController",
			controllerAs: "vC"
		}
	});
})();

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNoYXQvY2hhdC5tb2R1bGUuanMiLCJoaXN0b3J5L2hpc3RvcnkubW9kdWxlLmpzIiwiY2hhdC9pbnB1dC9pbnB1dC5tb2R1bGUuanMiLCJjaGF0L21lc3NhZ2VzL21lc3NhZ2VzLm1vZHVsZS5qcyIsImNoYXQvc29ja2V0L3NvY2tldC5tb2R1bGUuanMiLCJjaGF0L3ZpZXdlcnMvdmlld2Vycy5tb2R1bGUuanMiLCJhcHAuanMiLCJ2aXNpYmlsaXR5LnNlcnZpY2UuanMiLCJjaGF0L2NoYXQuY29udHJvbGxlci5qcyIsImNoYXQvY2hhdC5kaXJlY3RpdmUuanMiLCJoaXN0b3J5L2hpc3RvcnkuY29udHJvbGVyLmpzIiwiaGlzdG9yeS9oaXN0b3J5LnNlcnZpY2UuanMiLCJjaGF0L2lucHV0L2lucHV0LmNvbnRyb2xsZXIuanMiLCJjaGF0L2lucHV0L2lucHV0LmRpcmVjdGl2ZS5qcyIsImNoYXQvbWVzc2FnZXMvbWVzc2FnZXMuY29udHJvbGxlci5qcyIsImNoYXQvbWVzc2FnZXMvbWVzc2FnZXMuZGlyZWN0aXZlLmpzIiwiY2hhdC9zb2NrZXQvc29ja2V0LnNlcnZpY2UuanMiLCJjaGF0L3ZpZXdlcnMvdmlld2Vycy5jb250cm9sbGVyLmpzIiwiY2hhdC92aWV3ZXJzL3ZpZXdlcnMuZGlyZWN0aXZlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDVEE7QUFDQTtBQUNBO0FBQ0E7QUNIQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDSkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ0pBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNKQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDSkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMzQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdkJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ1hBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNWQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2ZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3ZCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN4REE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2JBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDZkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNsQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQzNGQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDekJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6InB1YmxpYy9zY3JpcHRzL2FwcC5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIoZnVuY3Rpb24oKSB7XG4gICAgY29uc3QgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2ZpbGVzeW5jLmNoYXQnLCBbXG4gICAgICAgIC8vJ2ZpbGVzeW5jLmNoYXQuYm90JyxcbiAgICAgICAgJ2ZpbGVzeW5jLmNoYXQuaW5wdXQnLFxuICAgICAgICAnZmlsZXN5bmMuY2hhdC5tZXNzYWdlcycsXG4gICAgICAgICdmaWxlc3luYy5jaGF0LnZpZXdlcnMnLFxuICAgICAgICAnZmlsZXN5bmMuY2hhdC5zb2NrZXQnXG4gICAgXSk7XG59KSgpO1xuIiwiKGZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdmaWxlc3luYy5oaXN0b3J5JywgW10pO1xufSkoKTtcbiIsIihmdW5jdGlvbigpIHtcbiAgICBjb25zdCBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnZmlsZXN5bmMuY2hhdC5pbnB1dCcsIFtcbiAgICBdKTtcbn0pKCk7XG4iLCIoZnVuY3Rpb24oKSB7XG4gICAgY29uc3QgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2ZpbGVzeW5jLmNoYXQubWVzc2FnZXMnLCBbXG4gICAgXSk7XG59KSgpO1xuIiwiKGZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdmaWxlc3luYy5jaGF0LnNvY2tldCcsIFtcbiAgICBdKTtcbn0pKCk7XG4iLCIoZnVuY3Rpb24oKSB7XG4gICAgY29uc3QgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2ZpbGVzeW5jLmNoYXQudmlld2VycycsIFtcbiAgICBdKTtcbn0pKCk7XG4iLCIoZnVuY3Rpb24gKCkge1xuXHRjb25zdCBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnZmlsZXN5bmMnLCBbXG5cdFx0J3VpLnJvdXRlcicsXG5cdFx0J25nQW5pbWF0ZScsXG5cdFx0J2hsanMnLFxuXG5cdFx0J2ZpbGVzeW5jLmNoYXQnLFxuXHRcdCdmaWxlc3luYy5oaXN0b3J5J1xuXHRdKTtcblxuXHRhcHAuY29uc3RhbnQoJ2lvJywgaW8pXG5cdFx0LmNvbnN0YW50KCdWaXNpYmlsaXR5JywgVmlzaWJpbGl0eSlcblx0XHQuY29uc3RhbnQoJ18nLCBfKTtcblxuXHRhcHAuY29uZmlnKGZ1bmN0aW9uICgkc3RhdGVQcm92aWRlciwgJGxvY2F0aW9uUHJvdmlkZXIsICR1cmxSb3V0ZXJQcm92aWRlcikge1xuXG5cdFx0JGxvY2F0aW9uUHJvdmlkZXIuaHRtbDVNb2RlKHRydWUpO1xuXG5cdFx0JHN0YXRlUHJvdmlkZXIuc3RhdGUoJ2luZGV4Jywge1xuXHRcdFx0dXJsOiAnLycsXG5cdFx0XHR0ZW1wbGF0ZVVybDogJy9pbmRleC5odG1sJ1xuXHRcdH0pO1xuXG5cdFx0JHVybFJvdXRlclByb3ZpZGVyLm90aGVyd2lzZSgnLycpO1xuXHR9KTtcblxufSkoKTtcbiIsIihmdW5jdGlvbiAoKSB7XG5cblx0YW5ndWxhci5tb2R1bGUoJ2ZpbGVzeW5jJylcblx0XHQuZmFjdG9yeSgndmlzaWJpbGl0eVNlcnZpY2UnLCBbJ1Zpc2liaWxpdHknLCAnc29ja2V0U2VydmljZScsXG4gICAgICAgICAgICBmdW5jdGlvbiAoVmlzaWJpbGl0eSwgc29ja2V0U2VydmljZSkge1xuXHRcdFx0XHRWaXNpYmlsaXR5LmNoYW5nZShmdW5jdGlvbiAoZXZ0LCBzdGF0ZSkge1xuXHRcdFx0XHRcdC8vIHN0YXRlID09PSAnaGlkZGVuJyB8fCAndmlzaWJsZSdcblx0XHRcdFx0XHRzb2NrZXRTZXJ2aWNlLnVzZXJDaGFuZ2VkU3RhdGUoc3RhdGUpO1xuXHRcdFx0XHR9KTtcblxuXHRcdFx0XHRzb2NrZXRTZXJ2aWNlLnVzZXJDaGFuZ2VkU3RhdGUoJ3Zpc2libGUnKTtcblxuXHRcdFx0XHR2YXIgc2VydmljZSA9IHtcblx0XHRcdFx0XHRzdGF0ZXM6IHt9XG5cdFx0XHRcdH07XG5cblx0XHRcdFx0c29ja2V0U2VydmljZS5vblZpc2liaWxpdHlTdGF0ZXNDaGFuZ2VkKGZ1bmN0aW9uIChzdGF0ZXMpIHtcblx0XHRcdFx0XHRzZXJ2aWNlLnN0YXRlcyA9IHN0YXRlcztcblx0XHRcdFx0fSk7XG5cdFx0XHRcdHJldHVybiBzZXJ2aWNlO1xuICAgICAgICAgICAgfVxuICAgICAgICBdKTtcbn0pKCk7XG4iLCIoZnVuY3Rpb24gKCkge1xuXG5cdGNvbnN0IGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdmaWxlc3luYy5jaGF0Jylcblx0XHQuY29udHJvbGxlcignY2hhdENvbnRyb2xsZXInLCBbJyRzY29wZScsIGZ1bmN0aW9uICgkc2NvcGUpIHtcbiAgICAgICAgICAgIC8vIE1heWJlIHVzZSBhbmd1bGFyLXNjcm9sbCBmb3IgbmV3IG1lc3NhZ2VzIHNjcm9sbCBkb3duIGFuZCBnb3RvIG1lc3NhZ2VzLCBwaW5uZWQgZXRjXG5cdFx0XHRsZXQgdm0gPSB0aGlzO1xuXG5cblxuXHRcdH1dKVxufSkoKTtcbiIsIihmdW5jdGlvbiAoKSB7XG5cdGNvbnN0IGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdmaWxlc3luYy5jaGF0Jyk7XG5cblx0YXBwLmRpcmVjdGl2ZSgnZnNDaGF0JywgZnVuY3Rpb24gKCkge1xuXHRcdHJldHVybiB7XG5cdFx0XHRyZXN0cmljdDogJ0FFJyxcblx0XHRcdHRlbXBsYXRlVXJsOiAnL2FwcC9jaGF0L2NoYXQucGFydC5odG1sJ1xuXHRcdH1cblx0fSk7XG59KSgpO1xuIiwiKGZ1bmN0aW9uICgpIHtcblxuXHRjb25zdCBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnZmlsZXN5bmMuaGlzdG9yeScpO1xuXG5cdGFwcC5jb250cm9sbGVyKCdoaXN0b3J5Q29udHJvbGxlcicsIFsnaGlzdG9yeVNlcnZpY2UnLCAndmlzaWJpbGl0eVNlcnZpY2UnLFxuICAgICAgICBmdW5jdGlvbiAoaGlzdG9yeVNlcnZpY2UsIHZpc2liaWxpdHlTZXJ2aWNlKSB7XG5cdFx0XHR0aGlzLmVkaXRzID0gaGlzdG9yeVNlcnZpY2UuZWRpdHM7XG5cdFx0XHR0aGlzLnZpc2liaWxpdHkgPSB2aXNpYmlsaXR5U2VydmljZTtcblxuXHRcdFx0dGhpcy5yZW1vdmUgPSBmdW5jdGlvbiAoZWRpdCkge1xuXHRcdFx0XHRoaXN0b3J5U2VydmljZS5yZW1vdmUoZWRpdCk7XG5cdFx0XHR9O1xuICB9XG5dKTtcbn0pKCk7XG4iLCIoZnVuY3Rpb24gKCkge1xuXG5cdGNvbnN0IGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdmaWxlc3luYy5oaXN0b3J5Jyk7XG5cblx0YXBwLmZhY3RvcnkoJ2hpc3RvcnlTZXJ2aWNlJywgZnVuY3Rpb24gKHNvY2tldFNlcnZpY2UsIF8pIHtcblx0XHR2YXIgZWRpdHMgPSBbXTtcblxuXHRcdHNvY2tldFNlcnZpY2Uub25GaWxlQ2hhbmdlZChmdW5jdGlvbiAoZmlsZW5hbWUsIHRpbWVzdGFtcCwgY29udGVudCkge1xuXHRcdFx0ZWRpdHMudW5zaGlmdCh7XG5cdFx0XHRcdGZpbGVuYW1lOiBmaWxlbmFtZSxcblx0XHRcdFx0dGltZXN0YW1wOiB0aW1lc3RhbXAsXG5cdFx0XHRcdGNvbnRlbnQ6IGNvbnRlbnRcblx0XHRcdH0pO1xuXHRcdH0pO1xuXG5cdFx0cmV0dXJuIHtcblx0XHRcdGVkaXRzOiBlZGl0cyxcblx0XHRcdHJlbW92ZTogZnVuY3Rpb24gKGVkaXQpIHtcblx0XHRcdFx0Xy5yZW1vdmUoZWRpdHMsIGVkaXQpO1xuXHRcdFx0fVxuXHRcdH07XG5cdH0pO1xufSkoKTtcbiIsIihmdW5jdGlvbiAoKSB7XG5cblx0Y29uc3QgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2ZpbGVzeW5jLmNoYXQuaW5wdXQnKVxuXHRcdC5jb250cm9sbGVyKCdpbnB1dENvbnRyb2xsZXInLCBbJyRzY29wZScsICdzb2NrZXRTZXJ2aWNlJywgZnVuY3Rpb24gKCRzY29wZSwgc29ja2V0U2VydmljZSkge1xuICAgICAgICAgICAgLy8gTWF5YmUgdXNlIGFuZ3VsYXItc2Nyb2xsIGZvciBuZXcgbWVzc2FnZXMgc2Nyb2xsIGRvd24gYW5kIGdvdG8gbWVzc2FnZXMsIHBpbm5lZCBldGNcblx0XHRcdGxldCB2bSA9IHRoaXM7XG5cdFx0XHR2YXIgYmFubmVkV29yZCA9IFtcIlwiLCBcIipcIiwgXCIgXCJdO1xuXG5cdFx0XHRmdW5jdGlvbiBhZGRCYW5uZWRXb3JkKHdvcmQpIHtcblx0XHRcdFx0dm0uYmFubmVkV29yZC5wdXNoKHdvcmQpO1xuXHRcdFx0fVxuXG5cdFx0XHRmdW5jdGlvbiBpc01zZ09rKG1zZykge1xuXHRcdFx0XHRyZXR1cm4gYmFubmVkV29yZC5maWx0ZXIoKHdvcmQpID0+IHdvcmQgPT09IG1zZylcblx0XHRcdFx0XHQubGVuZ3RoID09PSAwO1xuXHRcdFx0fVxuXG5cdFx0XHRmdW5jdGlvbiBpc01zZ1RvQm90KG1zZykge1xuXHRcdFx0XHRyZXR1cm4gbXNnLnNlYXJjaCgnIWJvdCcpID09IDA7XG5cdFx0XHR9XG5cblx0XHRcdGZ1bmN0aW9uIG5ld01zZ1RvQm90KG1zZykge1xuXHRcdFx0XHR2YXIgY29tbWFuZCA9IG1zZy5zcGxpdCgnICcpO1xuXHRcdFx0XHRjb25zb2xlLmxvZyhjb21tYW5kKTtcblx0XHRcdFx0c3dpdGNoKGNvbW1hbmRbMV0pIHtcblx0XHRcdFx0Y2FzZSAncm91bGV0dGUnOlxuXHRcdFx0XHRcdHNvY2tldFNlcnZpY2UuYm90Um91bGV0dGUoKTtcblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0Y2FzZSAnaW5mb0NvdXJzJzpcblx0XHRcdFx0XHRzb2NrZXRTZXJ2aWNlLmJvdEluZm9Db3VycygpO1xuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRjYXNlICd1cGRhdGVJbmZvJzpcblx0XHRcdFx0XHRjb21tYW5kLnNoaWZ0KCk7XG5cdFx0XHRcdFx0Y29tbWFuZC5zaGlmdCgpO1xuXHRcdFx0XHRcdHNvY2tldFNlcnZpY2UuYm90VXBkYXRlSW5mbyhjb21tYW5kLmpvaW4oJyAnKSk7XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdGNhc2UgJ2NvbW1hbmQnOlxuXHRcdFx0XHRcdHNvY2tldFNlcnZpY2UuYm90Q29tbWFuZCgpO1xuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdHZtLnNlbmRNZXNzYWdlID0gZnVuY3Rpb24gKCkge1xuXHRcdFx0XHR2YXIgbXNnID0gdm0ubWVzc2FnZTtcblx0XHRcdFx0aWYoaXNNc2dUb0JvdChtc2cpKSB7XG5cdFx0XHRcdFx0bmV3TXNnVG9Cb3QobXNnKTtcblx0XHRcdFx0fSBlbHNlIGlmKGlzTXNnT2sobXNnKSkge1xuXHRcdFx0XHRcdHNvY2tldFNlcnZpY2Uuc2VuZE1lc3NhZ2UobW9tZW50KClcblx0XHRcdFx0XHRcdC5mb3JtYXQoJ2g6bW0nKSwgbXNnKTtcblx0XHRcdFx0XHR2bS5tZXNzYWdlID0gJyc7XG5cdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0Y29uc29sZS5sb2coJ01vdCBpbnRlcmRpdCAhJyArIGJhbm5lZFdvcmQpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fV0pXG59KSgpO1xuIiwiKGZ1bmN0aW9uICgpIHtcblx0Y29uc3QgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2ZpbGVzeW5jLmNoYXQuaW5wdXQnKTtcblxuXHRhcHAuZGlyZWN0aXZlKCdmc0lucHV0JywgZnVuY3Rpb24gKCkge1xuXHRcdHJldHVybiB7XG5cdFx0XHRyZXN0cmljdDogJ0FFJyxcblx0XHRcdHRlbXBsYXRlVXJsOiAnL2FwcC9jaGF0L2lucHV0L2lucHV0LnBhcnQuaHRtbCcsXG5cdFx0XHQvLyBsaW5rOiBmdW5jdGlvbigpIHtcblx0XHRcdC8vXG5cdFx0XHQvLyB9XG5cdFx0fVxuXHR9KTtcbn0pKCk7XG4iLCIoZnVuY3Rpb24gKCkge1xuXHRjb25zdCBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnZmlsZXN5bmMuY2hhdC5tZXNzYWdlcycpXG5cdFx0LmNvbnRyb2xsZXIoJ21lc3NhZ2VzQ29udHJvbGxlcicsIFsnJHNjb3BlJywgJ3NvY2tldFNlcnZpY2UnLCBmdW5jdGlvbiAoJHNjb3BlLCBzb2NrZXRTZXJ2aWNlKSB7XG4gICAgICAgICAgICAvLyBNYXliZSB1c2UgYW5ndWxhci1zY3JvbGwgZm9yIG5ldyBtZXNzYWdlcyBzY3JvbGwgZG93biBhbmQgZ290byBtZXNzYWdlcywgcGlubmVkIGV0Y1xuXHRcdFx0bGV0IHZtID0gdGhpcztcblx0XHRcdHZtLm1lc3NhZ2VzID0gW107XG5cdFx0XHR2bS5tZXNzYWdlID0gJyc7XG5cdFx0XHRmdW5jdGlvbiBvbk1lc3NhZ2VzVXBkYXRlZChtZXNzYWdlcykge1xuXHRcdFx0XHR2bS5tZXNzYWdlcyA9IG1lc3NhZ2VzO1xuXHRcdFx0XHQkc2NvcGUuJGFwcGx5KCk7XG5cdFx0XHR9XG5cdFx0XHRzb2NrZXRTZXJ2aWNlLm9uTWVzc2FnZXNVcGRhdGVkKG9uTWVzc2FnZXNVcGRhdGVkLmJpbmQodm0pKTtcblxuXHRcdH1dKVxufSkoKTtcbiIsIihmdW5jdGlvbiAoKSB7XG5cdGNvbnN0IGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdmaWxlc3luYy5jaGF0Lm1lc3NhZ2VzJyk7XG5cblx0YXBwLmRpcmVjdGl2ZSgnZnNNZXNzYWdlcycsIGZ1bmN0aW9uICgpIHtcblx0XHRyZXR1cm4ge1xuXHRcdFx0cmVzdHJpY3Q6ICdBRScsXG5cdFx0XHR0ZW1wbGF0ZVVybDogJy9hcHAvY2hhdC9tZXNzYWdlcy9tZXNzYWdlcy5wYXJ0Lmh0bWwnLFxuXHRcdFx0Y29udHJvbGxlcjogXCJtZXNzYWdlc0NvbnRyb2xsZXJcIixcblx0XHRcdGNvbnRyb2xsZXJBczogXCJtQ1wiLFxuXHRcdFx0bGluazogZnVuY3Rpb24gKCRzY29wZSwgZWxlbWVudCkge1xuXHRcdFx0XHRsZXQgcmF3ID0gZWxlbWVudFswXS5jaGlsZHJlblswXTtcblx0XHRcdFx0JHNjb3BlLiR3YXRjaCgnbUMubWVzc2FnZXMnLCBmdW5jdGlvbiAobmV3VmFsdWUsIG9sZFZhbHVlKSB7XG5cdFx0XHRcdFx0cmF3LnNjcm9sbFRvcCA9IHJhdy5zY3JvbGxIZWlnaHQ7XG5cdFx0XHRcdH0pXG5cdFx0XHR9XG5cdFx0fVxuXHR9KTtcbn0pKCk7XG4iLCIoZnVuY3Rpb24gKCkge1xuXG5cblx0Y29uc3QgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2ZpbGVzeW5jLmNoYXQuc29ja2V0Jylcblx0XHQuZmFjdG9yeSgnc29ja2V0U2VydmljZScsIFsnaW8nLCAnXycsICckdGltZW91dCcsIGZ1bmN0aW9uIChpbywgXywgJHRpbWVvdXQpIHtcblx0XHRcdHZhciBzb2NrZXQgPSBpbygpO1xuXHRcdFx0dmFyIF9vbkZpbGVDaGFuZ2VkID0gXy5ub29wO1xuXHRcdFx0dmFyIF9vblZpc2liaWxpdHlTdGF0ZXNDaGFuZ2VkID0gXy5ub29wO1xuXG5cdFx0XHRzb2NrZXQub24oJ2Nvbm5lY3QnLCBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGNvbnNvbGUubG9nKCdjb25uZWN0ZWQnKTtcblx0XHRcdFx0dmFyIGxvZ2luID0gcHJvbXB0KCdOaWNrbmFtZT8nKTtcblx0XHRcdFx0aWYobG9naW4gPT0gbnVsbCkge1xuXHRcdFx0XHRcdGxvZ2luID0gXCJcIjtcblx0XHRcdFx0fVxuXHRcdFx0XHRzb2NrZXQuZW1pdCgndmlld2VyOm5ldycsIGxvZ2luKTtcblx0XHRcdH0pO1xuXG5cdFx0XHRzb2NrZXQub24oJ2ZpbGU6Y2hhbmdlZCcsIGZ1bmN0aW9uIChmaWxlbmFtZSwgdGltZXN0YW1wLCBjb250ZW50KSB7XG5cdFx0XHRcdCR0aW1lb3V0KGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0XHRfb25GaWxlQ2hhbmdlZChmaWxlbmFtZSwgdGltZXN0YW1wLCBjb250ZW50KTtcblx0XHRcdFx0fSk7XG5cdFx0XHR9KTtcblxuXHRcdFx0c29ja2V0Lm9uKCd2aWV3ZXItZXJyOm5hbWUnLCBmdW5jdGlvbiAobmlja25hbWUpIHtcblx0XHRcdFx0Y29uc29sZS5sb2coXCJFcnJldXIgc3VyIGxlIG5vbSBcIiArIG5pY2tuYW1lICsgXCIuXCIpO1xuXHRcdFx0XHR2YXIgbG9naW4gPSBwcm9tcHQoXCJFcnJldXIgc3VyIGxlIG5vbSBcIiArIG5pY2tuYW1lICsgXCIuXFxuTmV3IG5pY2tuYW1lP1wiKTtcblx0XHRcdFx0aWYobG9naW4gPT0gbnVsbCkge1xuXHRcdFx0XHRcdGxvZ2luID0gXCJcIjtcblx0XHRcdFx0fVxuXHRcdFx0XHRzb2NrZXQuZW1pdCgndmlld2VyOm5ldycsIGxvZ2luKTtcblx0XHRcdH0pO1xuXG5cdFx0XHRzb2NrZXQub24oJ3VzZXJzOnZpc2liaWxpdHktc3RhdGVzJywgZnVuY3Rpb24gKHN0YXRlcykge1xuXHRcdFx0XHQkdGltZW91dChmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdFx0X29uVmlzaWJpbGl0eVN0YXRlc0NoYW5nZWQoc3RhdGVzKTtcblx0XHRcdFx0fSk7XG5cdFx0XHR9KTtcblxuXHRcdFx0c29ja2V0Lm9uKCdlcnJvcjphdXRoJywgZnVuY3Rpb24gKGVycikge1xuXHRcdFx0XHQvLyBAdG9kbyB5ZXVya1xuXHRcdFx0XHRhbGVydChlcnIpO1xuXHRcdFx0fSk7XG5cblx0XHRcdHJldHVybiB7XG5cdFx0XHRcdG9uVmlld2Vyc1VwZGF0ZWQ6IGZ1bmN0aW9uIChmKSB7XG5cdFx0XHRcdFx0c29ja2V0Lm9uKCd2aWV3ZXJzOnVwZGF0ZWQnLCBmKTtcblx0XHRcdFx0fSxcblxuXHRcdFx0XHRzZW5kTWVzc2FnZTogZnVuY3Rpb24gKHRpbWUsIG1lc3NhZ2UpIHtcblx0XHRcdFx0XHRzb2NrZXQuZW1pdCgnbWVzc2FnZTpuZXcnLCB0aW1lLCBtZXNzYWdlKTtcblx0XHRcdFx0fSxcblxuXHRcdFx0XHR1cGRhdGVDb2xvcjogZnVuY3Rpb24gKGNvbG9yKSB7XG5cdFx0XHRcdFx0c29ja2V0LmVtaXQoJ2NvbG9yOnVwZGF0ZScsIGNvbG9yKVxuXHRcdFx0XHR9LFxuXG5cdFx0XHRcdG9uTWVzc2FnZXNVcGRhdGVkOiBmdW5jdGlvbiAoZikge1xuXHRcdFx0XHRcdHNvY2tldC5vbignbWVzc2FnZXM6dXBkYXRlZCcsIGYpO1xuXHRcdFx0XHR9LFxuXG5cdFx0XHRcdGJvdFJvdWxldHRlOiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdFx0c29ja2V0LmVtaXQoJ2JvdDpyb3VsZXR0ZScpO1xuXHRcdFx0XHR9LFxuXG5cdFx0XHRcdGJvdEluZm9Db3VyczogZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRcdHNvY2tldC5lbWl0KCdib3Q6aW5mbycpO1xuXHRcdFx0XHR9LFxuXG5cdFx0XHRcdGJvdFVwZGF0ZUluZm86IGZ1bmN0aW9uIChuZXdJbmZvKSB7XG5cdFx0XHRcdFx0c29ja2V0LmVtaXQoJ2JvdDp1cGRhdGVJbmZvJywgbmV3SW5mbyk7XG5cdFx0XHRcdH0sXG5cblx0XHRcdFx0Ym90Q29tbWFuZDogZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRcdHNvY2tldC5lbWl0KCdib3Q6Y29tbWFuZCcpO1xuXHRcdFx0XHR9LFxuXG5cdFx0XHRcdG9uRmlsZUNoYW5nZWQ6IGZ1bmN0aW9uIChmKSB7XG5cdFx0XHRcdFx0X29uRmlsZUNoYW5nZWQgPSBmO1xuXHRcdFx0XHR9LFxuXG5cdFx0XHRcdG9uVmlzaWJpbGl0eVN0YXRlc0NoYW5nZWQ6IGZ1bmN0aW9uIChmKSB7XG5cdFx0XHRcdFx0X29uVmlzaWJpbGl0eVN0YXRlc0NoYW5nZWQgPSBmO1xuXHRcdFx0XHR9LFxuXG5cdFx0XHRcdHVzZXJDaGFuZ2VkU3RhdGU6IGZ1bmN0aW9uIChzdGF0ZSkge1xuXHRcdFx0XHRcdHNvY2tldC5lbWl0KCd1c2VyLXZpc2liaWxpdHk6Y2hhbmdlZCcsIHN0YXRlKTtcblx0XHRcdFx0fVxuXHRcdFx0fTtcbiAgfV0pO1xufSkoKTtcbiIsIihmdW5jdGlvbiAoKSB7XG5cblx0Y29uc3QgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2ZpbGVzeW5jLmNoYXQnKVxuXHRcdC5jb250cm9sbGVyKCd2aWV3ZXJzQ29udHJvbGxlcicsIFsnJHNjb3BlJywgJ3NvY2tldFNlcnZpY2UnLCBmdW5jdGlvbiAoJHNjb3BlLCBzb2NrZXRTZXJ2aWNlKSB7XG4gICAgICAgICAgICAvLyBNYXliZSB1c2UgYW5ndWxhci1zY3JvbGwgZm9yIG5ldyBtZXNzYWdlcyBzY3JvbGwgZG93biBhbmQgZ290byBtZXNzYWdlcywgcGlubmVkIGV0Y1xuXHRcdFx0bGV0IHZtID0gdGhpcztcblx0XHRcdHZtLnZpZXdlcnMgPSBbXTtcblxuXHRcdFx0JHNjb3BlLm5pY2sgPSBcIk1hbG9cIjtcblxuXHRcdFx0ZnVuY3Rpb24gb25WaWV3ZXJzVXBkYXRlZCh2aWV3ZXJzKSB7XG5cdFx0XHRcdHZtLnZpZXdlcnMgPSB2aWV3ZXJzO1xuXHRcdFx0XHQkc2NvcGUuJGFwcGx5KCk7XG5cdFx0XHR9XG5cdFx0XHRzb2NrZXRTZXJ2aWNlLm9uVmlld2Vyc1VwZGF0ZWQob25WaWV3ZXJzVXBkYXRlZC5iaW5kKHZtKSk7XG5cblx0XHRcdGZ1bmN0aW9uIHNob3dDb2xvcihjb2xvcikge1xuXHRcdFx0XHRjb25zb2xlLmxvZyhjb2xvcik7XG5cdFx0XHR9XG5cblx0XHRcdHZtLnVwZGF0ZUNvbG9yID0gZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRzb2NrZXRTZXJ2aWNlLnVwZGF0ZUNvbG9yKHZtLmNvbG9yKTtcblx0XHRcdH1cblx0XHR9XSlcbn0pKCk7XG4iLCIoZnVuY3Rpb24gKCkge1xuXHRjb25zdCBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnZmlsZXN5bmMuY2hhdC52aWV3ZXJzJyk7XG5cblx0YXBwLmRpcmVjdGl2ZSgnZnNWaWV3ZXJzJywgZnVuY3Rpb24gKCkge1xuXHRcdHJldHVybiB7XG5cdFx0XHRyZXN0cmljdDogJ0FFJyxcblx0XHRcdHRlbXBsYXRlVXJsOiAnL2FwcC9jaGF0L3ZpZXdlcnMvdmlld2Vycy5wYXJ0Lmh0bWwnLFxuXHRcdFx0Y29udHJvbGxlcjogXCJ2aWV3ZXJzQ29udHJvbGxlclwiLFxuXHRcdFx0Y29udHJvbGxlckFzOiBcInZDXCJcblx0XHR9XG5cdH0pO1xufSkoKTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
