(function() {
    const app = angular.module('filesync.history', []);
})();

(function() {
    const app = angular.module('filesync.chat', [
        //'filesync.chat.bot',
        'filesync.chat.input',
        'filesync.chat.messages',
        'filesync.chat.viewers',
        'filesync.chat.socket'
    ]);
})();

(function() {
    const app = angular.module('filesync.chat.input', [
    ]);
})();

(function() {
    const app = angular.module('filesync.chat.messages', [
    ]);
})();

(function() {
    const app = angular.module('filesync.chat.socket', [
    ]);
})();

(function() {
    const app = angular.module('filesync.chat.viewers', [
    ]);
})();

(function () {
	const app = angular.module('filesync', [
		'ui.router',
		'ngAnimate',
		'hljs',
		'filesync.chat',
		'filesync.history'
	]);

	app.constant('io', io)
		.constant('Visibility', Visibility)
		.constant('_', _);

	app.config(function ($stateProvider, $locationProvider, $urlRouterProvider) {

		$locationProvider.html5Mode(true);
		$stateProvider.state('index', {
			url: '/',
			templateUrl: 'public/index.html'
		});

		$urlRouterProvider.otherwise('/');
	});

})();

(function () {

	angular.module('filesync')
		.factory('visibilityService', ['Visibility', 'socketService',
            function (Visibility, socketService) {
				Visibility.change(function (evt, state) {
					// state === 'hidden' || 'visible'
					socketService.userChangedState(state);
				});

				socketService.userChangedState('visible');

				var service = {
					states: {}
				};

				socketService.onVisibilityStatesChanged(function (states) {
					service.states = states;
				});
				return service;
            }
        ]);
})();

(function () {

	const app = angular.module('filesync.history');

	app.controller('historyController', ['historyService', 'visibilityService',
        function (historyService, visibilityService) {
			this.edits = historyService.edits;
			this.visibility = visibilityService;

			this.remove = function (edit) {
				historyService.remove(edit);
			};
  }
]);
})();

(function () {

	const app = angular.module('filesync.history');

	app.factory('historyService', function (socketService, _) {
		var edits = [];

		socketService.onFileChanged(function (filename, timestamp, content) {
			edits.unshift({
				filename: filename,
				timestamp: timestamp,
				content: content
			});
		});

		return {
			edits: edits,
			remove: function (edit) {
				_.remove(edits, edit);
			}
		};
	});
})();

(function () {
	const app = angular.module('filesync.chat');

	app.directive('chat', function () {
		return {
			restrict: 'AE',
			templateUrl: 'public/app/chat/chat.part.html'
		}
	});
})();

(function () {

	const app = angular.module('filesync.chat')
		.controller('inputController', ['$scope', 'socketService', function ($scope, socketService) {
            // Maybe use angular-scroll for new messages scroll down and goto messages, pinned etc
			let vm = this;
			var bannedWord = ["", "*", " "];

			function addBannedWord(word) {
				vm.bannedWord.push(word);
			}

			function isMsgOk(msg) {
				return bannedWord.filter((word) => word === msg)
					.length === 0;
			}

			function isMsgToBot(msg) {
				return msg.search('!bot') == 0;
			}

			function newMsgToBot(msg) {
				var command = msg.split(' ');
				console.log(command);
				switch(command[1]) {
				case 'roulette':
					socketService.botRoulette();
					break;
				case 'infoCours':
					socketService.botInfoCours();
					break;
				case 'updateInfo':
					command.shift();
					command.shift();
					socketService.botUpdateInfo(command.join(' '));
					break;
				case 'command':
					socketService.botCommand();
					break;
				}
			}

			vm.sendMessage = function () {
				var msg = vm.message;
				if(isMsgToBot(msg)) {
					newMsgToBot(msg);
				} else if(isMsgOk(msg)) {
					socketService.sendMessage(moment()
						.format('h:mm'), msg);
					vm.message = '';
				} else {
					console.log('Mot interdit !' + bannedWord);
				}
			}
		}])
})();


(function () {

	const app = angular.module('filesync.chat')
		.controller('messagesController', ['$scope', 'socketService', function ($scope, socketService) {
            // Maybe use angular-scroll for new messages scroll down and goto messages, pinned etc
			let vm = this;
			vm.messages = [];
			vm.message = '';
			function onMessagesUpdated(messages) {
				vm.messages = messages;
				$scope.$apply();
			}
			socketService.onMessagesUpdated(onMessagesUpdated.bind(vm));

		}])
})();

(function () {


	const app = angular.module('filesync.chat.socket')
		.factory('socketService', ['io', '_', '$timeout', function (io, _, $timeout) {
			var socket = io();
			var _onFileChanged = _.noop;
			var _onVisibilityStatesChanged = _.noop;

			socket.on('connect', function () {
				console.log('connected');
				var login = prompt('Nickname?');
				if(login == null) {
					login = "";
				}
				socket.emit('viewer:new', login);
			});

			socket.on('file:changed', function (filename, timestamp, content) {
				$timeout(function () {
					_onFileChanged(filename, timestamp, content);
				});
			});

			socket.on('viewer-err:name', function (nickname) {
				console.log("Erreur sur le nom " + nickname + ".");
				var login = prompt("Erreur sur le nom " + nickname + ".\nNew nickname?");
				if(login == null) {
					login = "";
				}
				socket.emit('viewer:new', login);
			});

			socket.on('users:visibility-states', function (states) {
				$timeout(function () {
					_onVisibilityStatesChanged(states);
				});
			});

			socket.on('error:auth', function (err) {
				// @todo yeurk
				alert(err);
			});

			return {
				onViewersUpdated: function (f) {
					socket.on('viewers:updated', f);
				},

				sendMessage: function (time, message) {
					socket.emit('message:new', time, message);
				},

				updateColor: function (color) {
					socket.emit('color:update', color)
				},

				onMessagesUpdated: function (f) {
					socket.on('messages:updated', f);
					console.log("COUCOU");
				},

				botRoulette: function () {
					socket.emit('bot:roulette');
				},

				botInfoCours: function () {
					socket.emit('bot:info');
				},

				botUpdateInfo: function (newInfo) {
					socket.emit('bot:updateInfo', newInfo);
				},

				botCommand: function () {
					socket.emit('bot:command');
				},

				onFileChanged: function (f) {
					_onFileChanged = f;
				},

				onVisibilityStatesChanged: function (f) {
					_onVisibilityStatesChanged = f;
				},

				userChangedState: function (state) {
					socket.emit('user-visibility:changed', state);
				}
			};
  }]);
})();

(function () {

	const app = angular.module('filesync.chat')
		.controller('viewersController', ['$scope', 'socketService', function ($scope, socketService) {
            // Maybe use angular-scroll for new messages scroll down and goto messages, pinned etc
			let vm = this;
			vm.viewers = [];

			$scope.nick = "Malo";

			function onViewersUpdated(viewers) {
				vm.viewers = viewers;
				$scope.$apply();
			}
			socketService.onViewersUpdated(onViewersUpdated.bind(vm));

			function showColor(color) {
				console.log(color);
			}

			vm.updateColor = function () {
				socketService.updateColor(vm.color);
			}
		}])
})();

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhpc3RvcnkvaGlzdG9yeS5tb2R1bGUuanMiLCJjaGF0L2NoYXQubW9kdWxlLmpzIiwiY2hhdC9pbnB1dC9pbnB1dC5tb2R1bGUuanMiLCJjaGF0L21lc3NhZ2VzL21lc3NhZ2VzLm1vZHVsZS5qcyIsImNoYXQvc29ja2V0L3NvY2tldC5tb2R1bGUuanMiLCJjaGF0L3ZpZXdlcnMvdmlld2Vycy5tb2R1bGUuanMiLCJhcHAuanMiLCJ2aXNpYmlsaXR5LnNlcnZpY2UuanMiLCJoaXN0b3J5L2hpc3RvcnkuY29udHJvbGVyLmpzIiwiaGlzdG9yeS9oaXN0b3J5LnNlcnZpY2UuanMiLCJjaGF0L2NoYXQuZGlyZWN0aXZlLmpzIiwiY2hhdC9pbnB1dC9pbnB1dC5jb250cm9sbGVyLmpzIiwiY2hhdC9pbnB1dC9pbnB1dC5kaXJlY3RpdmUuanMiLCJjaGF0L21lc3NhZ2VzL21lc3NhZ2VzLmNvbnRyb2xsZXIuanMiLCJjaGF0L3NvY2tldC9zb2NrZXQuc2VydmljZS5qcyIsImNoYXQvdmlld2Vycy92aWV3ZXJzLmNvbnRyb2xsZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7QUFDQTtBQUNBO0FBQ0E7QUNIQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ1RBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNKQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDSkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ0pBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNKQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDekJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3ZCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2ZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3ZCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDVkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDeERBO0FDQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2hCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM1RkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJwdWJsaWMvc2NyaXB0cy9hcHAubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdmaWxlc3luYy5oaXN0b3J5JywgW10pO1xufSkoKTtcbiIsIihmdW5jdGlvbigpIHtcbiAgICBjb25zdCBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnZmlsZXN5bmMuY2hhdCcsIFtcbiAgICAgICAgLy8nZmlsZXN5bmMuY2hhdC5ib3QnLFxuICAgICAgICAnZmlsZXN5bmMuY2hhdC5pbnB1dCcsXG4gICAgICAgICdmaWxlc3luYy5jaGF0Lm1lc3NhZ2VzJyxcbiAgICAgICAgJ2ZpbGVzeW5jLmNoYXQudmlld2VycycsXG4gICAgICAgICdmaWxlc3luYy5jaGF0LnNvY2tldCdcbiAgICBdKTtcbn0pKCk7XG4iLCIoZnVuY3Rpb24oKSB7XG4gICAgY29uc3QgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2ZpbGVzeW5jLmNoYXQuaW5wdXQnLCBbXG4gICAgXSk7XG59KSgpO1xuIiwiKGZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdmaWxlc3luYy5jaGF0Lm1lc3NhZ2VzJywgW1xuICAgIF0pO1xufSkoKTtcbiIsIihmdW5jdGlvbigpIHtcbiAgICBjb25zdCBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnZmlsZXN5bmMuY2hhdC5zb2NrZXQnLCBbXG4gICAgXSk7XG59KSgpO1xuIiwiKGZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdmaWxlc3luYy5jaGF0LnZpZXdlcnMnLCBbXG4gICAgXSk7XG59KSgpO1xuIiwiKGZ1bmN0aW9uICgpIHtcblx0Y29uc3QgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2ZpbGVzeW5jJywgW1xuXHRcdCd1aS5yb3V0ZXInLFxuXHRcdCduZ0FuaW1hdGUnLFxuXHRcdCdobGpzJyxcblx0XHQnZmlsZXN5bmMuY2hhdCcsXG5cdFx0J2ZpbGVzeW5jLmhpc3RvcnknXG5cdF0pO1xuXG5cdGFwcC5jb25zdGFudCgnaW8nLCBpbylcblx0XHQuY29uc3RhbnQoJ1Zpc2liaWxpdHknLCBWaXNpYmlsaXR5KVxuXHRcdC5jb25zdGFudCgnXycsIF8pO1xuXG5cdGFwcC5jb25maWcoZnVuY3Rpb24gKCRzdGF0ZVByb3ZpZGVyLCAkbG9jYXRpb25Qcm92aWRlciwgJHVybFJvdXRlclByb3ZpZGVyKSB7XG5cblx0XHQkbG9jYXRpb25Qcm92aWRlci5odG1sNU1vZGUodHJ1ZSk7XG5cdFx0JHN0YXRlUHJvdmlkZXIuc3RhdGUoJ2luZGV4Jywge1xuXHRcdFx0dXJsOiAnLycsXG5cdFx0XHR0ZW1wbGF0ZVVybDogJ3B1YmxpYy9pbmRleC5odG1sJ1xuXHRcdH0pO1xuXG5cdFx0JHVybFJvdXRlclByb3ZpZGVyLm90aGVyd2lzZSgnLycpO1xuXHR9KTtcblxufSkoKTtcbiIsIihmdW5jdGlvbiAoKSB7XG5cblx0YW5ndWxhci5tb2R1bGUoJ2ZpbGVzeW5jJylcblx0XHQuZmFjdG9yeSgndmlzaWJpbGl0eVNlcnZpY2UnLCBbJ1Zpc2liaWxpdHknLCAnc29ja2V0U2VydmljZScsXG4gICAgICAgICAgICBmdW5jdGlvbiAoVmlzaWJpbGl0eSwgc29ja2V0U2VydmljZSkge1xuXHRcdFx0XHRWaXNpYmlsaXR5LmNoYW5nZShmdW5jdGlvbiAoZXZ0LCBzdGF0ZSkge1xuXHRcdFx0XHRcdC8vIHN0YXRlID09PSAnaGlkZGVuJyB8fCAndmlzaWJsZSdcblx0XHRcdFx0XHRzb2NrZXRTZXJ2aWNlLnVzZXJDaGFuZ2VkU3RhdGUoc3RhdGUpO1xuXHRcdFx0XHR9KTtcblxuXHRcdFx0XHRzb2NrZXRTZXJ2aWNlLnVzZXJDaGFuZ2VkU3RhdGUoJ3Zpc2libGUnKTtcblxuXHRcdFx0XHR2YXIgc2VydmljZSA9IHtcblx0XHRcdFx0XHRzdGF0ZXM6IHt9XG5cdFx0XHRcdH07XG5cblx0XHRcdFx0c29ja2V0U2VydmljZS5vblZpc2liaWxpdHlTdGF0ZXNDaGFuZ2VkKGZ1bmN0aW9uIChzdGF0ZXMpIHtcblx0XHRcdFx0XHRzZXJ2aWNlLnN0YXRlcyA9IHN0YXRlcztcblx0XHRcdFx0fSk7XG5cdFx0XHRcdHJldHVybiBzZXJ2aWNlO1xuICAgICAgICAgICAgfVxuICAgICAgICBdKTtcbn0pKCk7XG4iLCIoZnVuY3Rpb24gKCkge1xuXG5cdGNvbnN0IGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdmaWxlc3luYy5oaXN0b3J5Jyk7XG5cblx0YXBwLmNvbnRyb2xsZXIoJ2hpc3RvcnlDb250cm9sbGVyJywgWydoaXN0b3J5U2VydmljZScsICd2aXNpYmlsaXR5U2VydmljZScsXG4gICAgICAgIGZ1bmN0aW9uIChoaXN0b3J5U2VydmljZSwgdmlzaWJpbGl0eVNlcnZpY2UpIHtcblx0XHRcdHRoaXMuZWRpdHMgPSBoaXN0b3J5U2VydmljZS5lZGl0cztcblx0XHRcdHRoaXMudmlzaWJpbGl0eSA9IHZpc2liaWxpdHlTZXJ2aWNlO1xuXG5cdFx0XHR0aGlzLnJlbW92ZSA9IGZ1bmN0aW9uIChlZGl0KSB7XG5cdFx0XHRcdGhpc3RvcnlTZXJ2aWNlLnJlbW92ZShlZGl0KTtcblx0XHRcdH07XG4gIH1cbl0pO1xufSkoKTtcbiIsIihmdW5jdGlvbiAoKSB7XG5cblx0Y29uc3QgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2ZpbGVzeW5jLmhpc3RvcnknKTtcblxuXHRhcHAuZmFjdG9yeSgnaGlzdG9yeVNlcnZpY2UnLCBmdW5jdGlvbiAoc29ja2V0U2VydmljZSwgXykge1xuXHRcdHZhciBlZGl0cyA9IFtdO1xuXG5cdFx0c29ja2V0U2VydmljZS5vbkZpbGVDaGFuZ2VkKGZ1bmN0aW9uIChmaWxlbmFtZSwgdGltZXN0YW1wLCBjb250ZW50KSB7XG5cdFx0XHRlZGl0cy51bnNoaWZ0KHtcblx0XHRcdFx0ZmlsZW5hbWU6IGZpbGVuYW1lLFxuXHRcdFx0XHR0aW1lc3RhbXA6IHRpbWVzdGFtcCxcblx0XHRcdFx0Y29udGVudDogY29udGVudFxuXHRcdFx0fSk7XG5cdFx0fSk7XG5cblx0XHRyZXR1cm4ge1xuXHRcdFx0ZWRpdHM6IGVkaXRzLFxuXHRcdFx0cmVtb3ZlOiBmdW5jdGlvbiAoZWRpdCkge1xuXHRcdFx0XHRfLnJlbW92ZShlZGl0cywgZWRpdCk7XG5cdFx0XHR9XG5cdFx0fTtcblx0fSk7XG59KSgpO1xuIiwiKGZ1bmN0aW9uICgpIHtcblx0Y29uc3QgYXBwID0gYW5ndWxhci5tb2R1bGUoJ2ZpbGVzeW5jLmNoYXQnKTtcblxuXHRhcHAuZGlyZWN0aXZlKCdjaGF0JywgZnVuY3Rpb24gKCkge1xuXHRcdHJldHVybiB7XG5cdFx0XHRyZXN0cmljdDogJ0FFJyxcblx0XHRcdHRlbXBsYXRlVXJsOiAncHVibGljL2FwcC9jaGF0L2NoYXQucGFydC5odG1sJ1xuXHRcdH1cblx0fSk7XG59KSgpO1xuIiwiKGZ1bmN0aW9uICgpIHtcblxuXHRjb25zdCBhcHAgPSBhbmd1bGFyLm1vZHVsZSgnZmlsZXN5bmMuY2hhdCcpXG5cdFx0LmNvbnRyb2xsZXIoJ2lucHV0Q29udHJvbGxlcicsIFsnJHNjb3BlJywgJ3NvY2tldFNlcnZpY2UnLCBmdW5jdGlvbiAoJHNjb3BlLCBzb2NrZXRTZXJ2aWNlKSB7XG4gICAgICAgICAgICAvLyBNYXliZSB1c2UgYW5ndWxhci1zY3JvbGwgZm9yIG5ldyBtZXNzYWdlcyBzY3JvbGwgZG93biBhbmQgZ290byBtZXNzYWdlcywgcGlubmVkIGV0Y1xuXHRcdFx0bGV0IHZtID0gdGhpcztcblx0XHRcdHZhciBiYW5uZWRXb3JkID0gW1wiXCIsIFwiKlwiLCBcIiBcIl07XG5cblx0XHRcdGZ1bmN0aW9uIGFkZEJhbm5lZFdvcmQod29yZCkge1xuXHRcdFx0XHR2bS5iYW5uZWRXb3JkLnB1c2god29yZCk7XG5cdFx0XHR9XG5cblx0XHRcdGZ1bmN0aW9uIGlzTXNnT2sobXNnKSB7XG5cdFx0XHRcdHJldHVybiBiYW5uZWRXb3JkLmZpbHRlcigod29yZCkgPT4gd29yZCA9PT0gbXNnKVxuXHRcdFx0XHRcdC5sZW5ndGggPT09IDA7XG5cdFx0XHR9XG5cblx0XHRcdGZ1bmN0aW9uIGlzTXNnVG9Cb3QobXNnKSB7XG5cdFx0XHRcdHJldHVybiBtc2cuc2VhcmNoKCchYm90JykgPT0gMDtcblx0XHRcdH1cblxuXHRcdFx0ZnVuY3Rpb24gbmV3TXNnVG9Cb3QobXNnKSB7XG5cdFx0XHRcdHZhciBjb21tYW5kID0gbXNnLnNwbGl0KCcgJyk7XG5cdFx0XHRcdGNvbnNvbGUubG9nKGNvbW1hbmQpO1xuXHRcdFx0XHRzd2l0Y2goY29tbWFuZFsxXSkge1xuXHRcdFx0XHRjYXNlICdyb3VsZXR0ZSc6XG5cdFx0XHRcdFx0c29ja2V0U2VydmljZS5ib3RSb3VsZXR0ZSgpO1xuXHRcdFx0XHRcdGJyZWFrO1xuXHRcdFx0XHRjYXNlICdpbmZvQ291cnMnOlxuXHRcdFx0XHRcdHNvY2tldFNlcnZpY2UuYm90SW5mb0NvdXJzKCk7XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdGNhc2UgJ3VwZGF0ZUluZm8nOlxuXHRcdFx0XHRcdGNvbW1hbmQuc2hpZnQoKTtcblx0XHRcdFx0XHRjb21tYW5kLnNoaWZ0KCk7XG5cdFx0XHRcdFx0c29ja2V0U2VydmljZS5ib3RVcGRhdGVJbmZvKGNvbW1hbmQuam9pbignICcpKTtcblx0XHRcdFx0XHRicmVhaztcblx0XHRcdFx0Y2FzZSAnY29tbWFuZCc6XG5cdFx0XHRcdFx0c29ja2V0U2VydmljZS5ib3RDb21tYW5kKCk7XG5cdFx0XHRcdFx0YnJlYWs7XG5cdFx0XHRcdH1cblx0XHRcdH1cblxuXHRcdFx0dm0uc2VuZE1lc3NhZ2UgPSBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdHZhciBtc2cgPSB2bS5tZXNzYWdlO1xuXHRcdFx0XHRpZihpc01zZ1RvQm90KG1zZykpIHtcblx0XHRcdFx0XHRuZXdNc2dUb0JvdChtc2cpO1xuXHRcdFx0XHR9IGVsc2UgaWYoaXNNc2dPayhtc2cpKSB7XG5cdFx0XHRcdFx0c29ja2V0U2VydmljZS5zZW5kTWVzc2FnZShtb21lbnQoKVxuXHRcdFx0XHRcdFx0LmZvcm1hdCgnaDptbScpLCBtc2cpO1xuXHRcdFx0XHRcdHZtLm1lc3NhZ2UgPSAnJztcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRjb25zb2xlLmxvZygnTW90IGludGVyZGl0ICEnICsgYmFubmVkV29yZCk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XSlcbn0pKCk7XG4iLCIiLCIoZnVuY3Rpb24gKCkge1xuXG5cdGNvbnN0IGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdmaWxlc3luYy5jaGF0Jylcblx0XHQuY29udHJvbGxlcignbWVzc2FnZXNDb250cm9sbGVyJywgWyckc2NvcGUnLCAnc29ja2V0U2VydmljZScsIGZ1bmN0aW9uICgkc2NvcGUsIHNvY2tldFNlcnZpY2UpIHtcbiAgICAgICAgICAgIC8vIE1heWJlIHVzZSBhbmd1bGFyLXNjcm9sbCBmb3IgbmV3IG1lc3NhZ2VzIHNjcm9sbCBkb3duIGFuZCBnb3RvIG1lc3NhZ2VzLCBwaW5uZWQgZXRjXG5cdFx0XHRsZXQgdm0gPSB0aGlzO1xuXHRcdFx0dm0ubWVzc2FnZXMgPSBbXTtcblx0XHRcdHZtLm1lc3NhZ2UgPSAnJztcblx0XHRcdGZ1bmN0aW9uIG9uTWVzc2FnZXNVcGRhdGVkKG1lc3NhZ2VzKSB7XG5cdFx0XHRcdHZtLm1lc3NhZ2VzID0gbWVzc2FnZXM7XG5cdFx0XHRcdCRzY29wZS4kYXBwbHkoKTtcblx0XHRcdH1cblx0XHRcdHNvY2tldFNlcnZpY2Uub25NZXNzYWdlc1VwZGF0ZWQob25NZXNzYWdlc1VwZGF0ZWQuYmluZCh2bSkpO1xuXG5cdFx0fV0pXG59KSgpO1xuIiwiKGZ1bmN0aW9uICgpIHtcblxuXG5cdGNvbnN0IGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdmaWxlc3luYy5jaGF0LnNvY2tldCcpXG5cdFx0LmZhY3RvcnkoJ3NvY2tldFNlcnZpY2UnLCBbJ2lvJywgJ18nLCAnJHRpbWVvdXQnLCBmdW5jdGlvbiAoaW8sIF8sICR0aW1lb3V0KSB7XG5cdFx0XHR2YXIgc29ja2V0ID0gaW8oKTtcblx0XHRcdHZhciBfb25GaWxlQ2hhbmdlZCA9IF8ubm9vcDtcblx0XHRcdHZhciBfb25WaXNpYmlsaXR5U3RhdGVzQ2hhbmdlZCA9IF8ubm9vcDtcblxuXHRcdFx0c29ja2V0Lm9uKCdjb25uZWN0JywgZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRjb25zb2xlLmxvZygnY29ubmVjdGVkJyk7XG5cdFx0XHRcdHZhciBsb2dpbiA9IHByb21wdCgnTmlja25hbWU/Jyk7XG5cdFx0XHRcdGlmKGxvZ2luID09IG51bGwpIHtcblx0XHRcdFx0XHRsb2dpbiA9IFwiXCI7XG5cdFx0XHRcdH1cblx0XHRcdFx0c29ja2V0LmVtaXQoJ3ZpZXdlcjpuZXcnLCBsb2dpbik7XG5cdFx0XHR9KTtcblxuXHRcdFx0c29ja2V0Lm9uKCdmaWxlOmNoYW5nZWQnLCBmdW5jdGlvbiAoZmlsZW5hbWUsIHRpbWVzdGFtcCwgY29udGVudCkge1xuXHRcdFx0XHQkdGltZW91dChmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdFx0X29uRmlsZUNoYW5nZWQoZmlsZW5hbWUsIHRpbWVzdGFtcCwgY29udGVudCk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fSk7XG5cblx0XHRcdHNvY2tldC5vbigndmlld2VyLWVycjpuYW1lJywgZnVuY3Rpb24gKG5pY2tuYW1lKSB7XG5cdFx0XHRcdGNvbnNvbGUubG9nKFwiRXJyZXVyIHN1ciBsZSBub20gXCIgKyBuaWNrbmFtZSArIFwiLlwiKTtcblx0XHRcdFx0dmFyIGxvZ2luID0gcHJvbXB0KFwiRXJyZXVyIHN1ciBsZSBub20gXCIgKyBuaWNrbmFtZSArIFwiLlxcbk5ldyBuaWNrbmFtZT9cIik7XG5cdFx0XHRcdGlmKGxvZ2luID09IG51bGwpIHtcblx0XHRcdFx0XHRsb2dpbiA9IFwiXCI7XG5cdFx0XHRcdH1cblx0XHRcdFx0c29ja2V0LmVtaXQoJ3ZpZXdlcjpuZXcnLCBsb2dpbik7XG5cdFx0XHR9KTtcblxuXHRcdFx0c29ja2V0Lm9uKCd1c2Vyczp2aXNpYmlsaXR5LXN0YXRlcycsIGZ1bmN0aW9uIChzdGF0ZXMpIHtcblx0XHRcdFx0JHRpbWVvdXQoZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRcdF9vblZpc2liaWxpdHlTdGF0ZXNDaGFuZ2VkKHN0YXRlcyk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fSk7XG5cblx0XHRcdHNvY2tldC5vbignZXJyb3I6YXV0aCcsIGZ1bmN0aW9uIChlcnIpIHtcblx0XHRcdFx0Ly8gQHRvZG8geWV1cmtcblx0XHRcdFx0YWxlcnQoZXJyKTtcblx0XHRcdH0pO1xuXG5cdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRvblZpZXdlcnNVcGRhdGVkOiBmdW5jdGlvbiAoZikge1xuXHRcdFx0XHRcdHNvY2tldC5vbigndmlld2Vyczp1cGRhdGVkJywgZik7XG5cdFx0XHRcdH0sXG5cblx0XHRcdFx0c2VuZE1lc3NhZ2U6IGZ1bmN0aW9uICh0aW1lLCBtZXNzYWdlKSB7XG5cdFx0XHRcdFx0c29ja2V0LmVtaXQoJ21lc3NhZ2U6bmV3JywgdGltZSwgbWVzc2FnZSk7XG5cdFx0XHRcdH0sXG5cblx0XHRcdFx0dXBkYXRlQ29sb3I6IGZ1bmN0aW9uIChjb2xvcikge1xuXHRcdFx0XHRcdHNvY2tldC5lbWl0KCdjb2xvcjp1cGRhdGUnLCBjb2xvcilcblx0XHRcdFx0fSxcblxuXHRcdFx0XHRvbk1lc3NhZ2VzVXBkYXRlZDogZnVuY3Rpb24gKGYpIHtcblx0XHRcdFx0XHRzb2NrZXQub24oJ21lc3NhZ2VzOnVwZGF0ZWQnLCBmKTtcblx0XHRcdFx0XHRjb25zb2xlLmxvZyhcIkNPVUNPVVwiKTtcblx0XHRcdFx0fSxcblxuXHRcdFx0XHRib3RSb3VsZXR0ZTogZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRcdHNvY2tldC5lbWl0KCdib3Q6cm91bGV0dGUnKTtcblx0XHRcdFx0fSxcblxuXHRcdFx0XHRib3RJbmZvQ291cnM6IGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0XHRzb2NrZXQuZW1pdCgnYm90OmluZm8nKTtcblx0XHRcdFx0fSxcblxuXHRcdFx0XHRib3RVcGRhdGVJbmZvOiBmdW5jdGlvbiAobmV3SW5mbykge1xuXHRcdFx0XHRcdHNvY2tldC5lbWl0KCdib3Q6dXBkYXRlSW5mbycsIG5ld0luZm8pO1xuXHRcdFx0XHR9LFxuXG5cdFx0XHRcdGJvdENvbW1hbmQ6IGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0XHRzb2NrZXQuZW1pdCgnYm90OmNvbW1hbmQnKTtcblx0XHRcdFx0fSxcblxuXHRcdFx0XHRvbkZpbGVDaGFuZ2VkOiBmdW5jdGlvbiAoZikge1xuXHRcdFx0XHRcdF9vbkZpbGVDaGFuZ2VkID0gZjtcblx0XHRcdFx0fSxcblxuXHRcdFx0XHRvblZpc2liaWxpdHlTdGF0ZXNDaGFuZ2VkOiBmdW5jdGlvbiAoZikge1xuXHRcdFx0XHRcdF9vblZpc2liaWxpdHlTdGF0ZXNDaGFuZ2VkID0gZjtcblx0XHRcdFx0fSxcblxuXHRcdFx0XHR1c2VyQ2hhbmdlZFN0YXRlOiBmdW5jdGlvbiAoc3RhdGUpIHtcblx0XHRcdFx0XHRzb2NrZXQuZW1pdCgndXNlci12aXNpYmlsaXR5OmNoYW5nZWQnLCBzdGF0ZSk7XG5cdFx0XHRcdH1cblx0XHRcdH07XG4gIH1dKTtcbn0pKCk7XG4iLCIoZnVuY3Rpb24gKCkge1xuXG5cdGNvbnN0IGFwcCA9IGFuZ3VsYXIubW9kdWxlKCdmaWxlc3luYy5jaGF0Jylcblx0XHQuY29udHJvbGxlcigndmlld2Vyc0NvbnRyb2xsZXInLCBbJyRzY29wZScsICdzb2NrZXRTZXJ2aWNlJywgZnVuY3Rpb24gKCRzY29wZSwgc29ja2V0U2VydmljZSkge1xuICAgICAgICAgICAgLy8gTWF5YmUgdXNlIGFuZ3VsYXItc2Nyb2xsIGZvciBuZXcgbWVzc2FnZXMgc2Nyb2xsIGRvd24gYW5kIGdvdG8gbWVzc2FnZXMsIHBpbm5lZCBldGNcblx0XHRcdGxldCB2bSA9IHRoaXM7XG5cdFx0XHR2bS52aWV3ZXJzID0gW107XG5cblx0XHRcdCRzY29wZS5uaWNrID0gXCJNYWxvXCI7XG5cblx0XHRcdGZ1bmN0aW9uIG9uVmlld2Vyc1VwZGF0ZWQodmlld2Vycykge1xuXHRcdFx0XHR2bS52aWV3ZXJzID0gdmlld2Vycztcblx0XHRcdFx0JHNjb3BlLiRhcHBseSgpO1xuXHRcdFx0fVxuXHRcdFx0c29ja2V0U2VydmljZS5vblZpZXdlcnNVcGRhdGVkKG9uVmlld2Vyc1VwZGF0ZWQuYmluZCh2bSkpO1xuXG5cdFx0XHRmdW5jdGlvbiBzaG93Q29sb3IoY29sb3IpIHtcblx0XHRcdFx0Y29uc29sZS5sb2coY29sb3IpO1xuXHRcdFx0fVxuXG5cdFx0XHR2bS51cGRhdGVDb2xvciA9IGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0c29ja2V0U2VydmljZS51cGRhdGVDb2xvcih2bS5jb2xvcik7XG5cdFx0XHR9XG5cdFx0fV0pXG59KSgpO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
